
// --- CONFIGURATION ---
const RAZORPAY_KEY_ID = 'rzp_test_S4udspy6Qey72w'; // Public Key ID
const BRAND_COLOR = '#2E7D32'; // FarmoTech Green
const BRAND_NAME = 'FarmoTech';

// API Endpoints (Replace with your actual backend routes if different)
const API_ENDPOINTS = {
    CREATE_ORDER: '/api/payment/create-order',
    VERIFY_PAYMENT: '/api/payment/verify'
};

/**
 * Initiates the payment process for a specific contract.
 * @param {string} contractId - The ID of the digital contract.
 * @param {number} amount - The amount to be paid in INR.
 */
async function makePayment(contractId, amount) {
    console.log(`Starting payment process for Contract: ${contractId}, Amount: â‚¹${amount}`);

    try {
        // --- STEP 1: Create Order on Backend ---
        // We do not create the order here directly to hide the Secret Key.
        const orderData = await createBackendOrder(contractId, amount);

        if (!orderData || !orderData.id) {
            throw new Error('Invalid order data received from backend.');
        }

        console.log('Order created successfully:', orderData.id);

        // --- STEP 2: Configure Razorpay Options ---
        const options = {
            key: RAZORPAY_KEY_ID, // Public Key
            amount: orderData.amount, // Amount in paise (from backend)
            currency: orderData.currency, // INR
            name: BRAND_NAME,
            description: `Contract Payment #${contractId}`,
            image: '/images/logo.png', // Optional: Path to FarmoTech logo
            order_id: orderData.id, // The ID generated by the backend

            // --- STEP 3: Payment Success Handler ---
            // This function triggers automatically when payment is successful
            handler: async function (response) {
                console.log('Payment success! Verifying signature...');
                await verifyBackendPayment(response, contractId);
            },

            // Prefill Data (For Demo/Hackathon ease of use)
            prefill: {
                name: "FarmoTech User",
                email: "demo.user@farmotech.com",
                contact: "9999999999"
            },

            // Branding
            theme: {
                color: BRAND_COLOR
            }
        };

        // --- STEP 4: Open Razorpay Checkout ---
        const rzp1 = new Razorpay(options);

        // Handle Payment Failed (User closes window or transaction fails)
        rzp1.on('payment.failed', function (response) {
            console.error('Payment Failed:', response.error);
            alert(`Payment Failed: ${response.error.description}`);
        });

        rzp1.open();

    } catch (error) {
        console.error('Error initiating payment:', error);
        alert('Could not initiate payment. Check console for details.');
    }
}

/**
 * Helper: Calls the backend to create a Razorpay Order.
 */
async function createBackendOrder(contractId, amount) {
    try {
        const response = await fetch(API_ENDPOINTS.CREATE_ORDER, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contractId, amount })
        });

        if (!response.ok) throw new Error('Network response was not ok');
        
        // Expected response: { id: "order_xyz...", amount: 50000, currency: "INR" }
        return await response.json(); 
    } catch (error) {
        console.error('Backend Order Creation Failed:', error);
        throw error; // Propagate error to main function
    }
}

/**
 * Helper: Calls the backend to verify the Payment Signature.
 * This is crucial for security. Never trust the frontend success alone.
 */
async function verifyBackendPayment(paymentResponse, contractId) {
    try {
        const verifyPayload = {
            razorpay_order_id: paymentResponse.razorpay_order_id,
            razorpay_payment_id: paymentResponse.razorpay_payment_id,
            razorpay_signature: paymentResponse.razorpay_signature,
            contractId: contractId
        };

        const response = await fetch(API_ENDPOINTS.VERIFY_PAYMENT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(verifyPayload)
        });

        const result = await response.json();

        if (result.success) {
            // Success Flow
            console.log('Signature Verified. Payment Complete.');
            alert('Payment Successful! Contract secured.');
            // Optional: Redirect to contract details page
            // window.location.href = `/contracts/${contractId}`;
        } else {
            // Failure Flow (Signature mismatch)
            console.error('Signature Verification Failed');
            alert('Payment verification failed. Please contact support.');
        }

    } catch (error) {
        console.error('Verification API Error:', error);
        alert('Payment succeeded but verification failed due to network error.');
    }
}

// Export for module usage (optional) or attach to window
window.makePayment = makePayment;